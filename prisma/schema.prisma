// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  // For PostgreSQL, change to: provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  password          String
  name              String?
  activityLevel     String?  // "moderate" | "very_active" | "extra_active" | null = sedentary
  // Goals (main source for dashboard progress; when set, item-level targets for matching units are disabled)
  ammoGoalRounds    Float?
  waterGoalGallons  Float?
  foodGoalDays      Float?   // Days of food; target calories = household daily calories Ã— this
  fuelGoalGallons   Float?
  fuelGoalKwh       Float?   // Total kWh (generator + battery)
  fuelGoalBatteryKwh Float?  // Battery storage only (kWh)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  items             Item[]
  categories        Category[]
  locations         Location[]
  events            Event[]
  consumptionLogs   ConsumptionLog[]
  notificationSettings NotificationSettings?
  testDataRecords   TestDataRecord[]
  familyMembers     FamilyMember[]
}

model FamilyMember {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String?  // Optional display name (e.g. "Mom", "Child 1")
  age       Int      // Years
  weightKg  Float    // Weight in kilograms
  heightCm  Float    // Height in centimeters
  sex       String   // "male" | "female" (for calorie formula)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model TestDataRecord {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  recordId  String   // id of the category, location, item, consumption_log, or event
  kind      String   // "category" | "location" | "item" | "consumption_log" | "event"
  createdAt DateTime @default(now())

  @@index([userId])
}

model Category {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?  // Hex color for UI
  icon        String?  // Icon name
  targetQuantity Float @default(0)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       Item[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

model Location {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       Item[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

model Item {
  id                  String    @id @default(cuid())
  name                String
  description         String?
  quantity            Float     @default(0)
  unit                String    // e.g., "gallons", "rounds", "days", "pieces"
  categoryId          String
  category            Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  locationId          String
  location            Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  userId              String
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  events              Event[]
  consumptionLogs     ConsumptionLog[]
  
  // Optional attributes
  expirationDate      DateTime?
  maintenanceInterval Int?      // Days between maintenance
  lastMaintenanceDate DateTime?
  rotationSchedule   Int?      // Days between rotations
  lastRotationDate   DateTime?
  notes               String?
  imageUrl            String?
  qrCode              String?   // QR code data
  minQuantity         Float     @default(0) // Low inventory threshold
  targetQuantity      Float     @default(0)
  caloriesPerUnit     Float?    // For food items: calories per unit (e.g. per can) for Days of Food
  // Tracking
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([userId])
  @@index([categoryId])
  @@index([locationId])
  @@index([expirationDate])
  @@index([lastMaintenanceDate])
}

model ConsumptionLog {
  id        String   @id @default(cuid())
  itemId    String
  item      Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quantity  Float    // Amount consumed or added
  type      String   @default("consumption") // "consumption" | "addition"
  note      String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([itemId])
  @@index([createdAt])
}

model Event {
  id          String   @id @default(cuid())
  type        String   // "expiration", "maintenance", "rotation", "battery_replacement"
  title       String
  description String?
  date        DateTime
  itemId      String?
  item        Item?    @relation(fields: [itemId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  completed   Boolean  @default(false)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([date])
  @@index([type])
  @@index([completed])
  @@index([itemId, userId, type])
}

model NotificationSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emailEnabled          Boolean  @default(true)
  emailExpirationDays   Int      @default(7)  // Notify X days before expiration
  emailMaintenanceDays  Int      @default(3)  // Notify X days before maintenance
  emailRotationDays     Int      @default(1)  // Notify X days before rotation
  emailLowInventory     Boolean  @default(true)
  inAppEnabled          Boolean  @default(true)
  webhookEnabled        Boolean  @default(false)
  webhookUrl            String?   // Webhook endpoint URL
  webhookSecret         String?   // Optional secret for webhook signing
  webhookExpirationDays Int      @default(7)  // Notify X days before expiration
  webhookMaintenanceDays Int     @default(3)  // Notify X days before maintenance
  webhookRotationDays   Int      @default(1)  // Notify X days before rotation
  webhookLowInventory   Boolean  @default(true)
  smtpHost              String?
  smtpPort              Int?
  smtpUser              String?
  smtpPassword          String?
  smtpFrom              String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

